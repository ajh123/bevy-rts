# Critical Codebase Review

Latest commit: `a63f968a17e16378b7c9ddeec6e0b802f8913757`
Date: 08-01-2026

## Summary
The codebase demonstrates a basic understanding of Rust syntax but a fundamental misunderstanding of the Bevy engine's architecture. It actively "fights" the framework by reimplementing features that Bevy provides out-of-the-box, resulting in redundant state management, poor performance patterns, and unnecessary complexity.

## 1. Architectural Flaws: Fighting the ECS

### Redundant Object Storage (`ObjectWorld`)
The most glaring issue is the implementation of `ObjectWorld` in `src/game/world/objects/storage.rs`.
- **The Problem:** You have implemented a custom generational arena (`ObjectSlot`, `generation`, `free_list`) to store game objects. **Bevy's `Entity` is already a 64-bit generational index.**
- **Consequence:** You are maintaining two parallel hierarchies: your custom `ObjectWorld` and Bevy's `World`. This requires manual synchronization (e.g., `sync_objects` system), adds complexity, introduces bugs where state desynchronizes, and prevents you from using Bevy's query system effectively for game logic.
- **Fix:** Delete `ObjectWorld`. Use `Commands::spawn` to create entities. Use components (`Component`) to store data like `ObjectTypeId`, `Position`, etc.

### Manual Input/Physics Glue
In `src/game/input.rs`, `raycast_to_heightfield` implements a manual raymarching algorithm against `TerrainWorld` data.
- **The Problem:** While acceptable for a prototype, this logic is tightly coupled to the input system.
- **Consequence:** Input handling logic is polluted with physics/collision code.
- **Fix:** Move raycasting logic to a `physics` or `terrain` module. Expose a generic `Raycast` trait or system.

## 2. Performance Anti-Patterns

### Synchronous I/O in Asset Loading
`src/game/utils/gltf.rs` contains `try_compute_gltf_bounds_in_parent_space`.
- **The Problem:** This function uses `std::fs::read_to_string` to read files from the "assets" folder.
- **Severity:** **Critical.**
- **Why:**
    1.  **Blocks Execution:** Synchronous I/O blocks the main thread.
    2.  **Platform Incompatibility:** This code will crash on Wasm/Web builds or Android/iOS where the filesystem is virtualized or packed.
    3.  **Bypasses Asset Server:** Bevy has a robust `AssetServer`. You are ignoring it to parse JSON manually.
- **Fix:** Use `bevy::gltf` helpers or pre-process assets. Never use `std::fs` inside runtime game logic for assets.

### O(N) Picking Logic
`ObjectWorld::pick_hovered` iterates through **every single object** in the world to check for mouse intersection.
- **The Problem:** Linear complexity $O(N)$.
- **Consequence:** As the object count grows, frame rate will plummet solely due to moving the mouse.
- **Fix:** If you use Bevy's ECS, you can use existing spatial query plugins (like `bevy_xpbd` or `bevy_rapier`) or implemented a simple spatial partition grid.

## 3. Modularization & Separation of Concerns

### `main.rs` Bloat
- `src/main.rs` is a dumping ground for setup logic. It manually inserts resources for `TerrainConfig`, `AmbientLight`, etc.
- **Fix:** encapsulate this setup into `Plugins`. e.g., `app.add_plugins(TerrainPlugin)`. `TerrainPlugin` should handle its own resource registration.

### Leaky Abstractions
- **Camera Coupling:** `src/game/camera.rs` initializes a `DirectionalLight`. A camera module should not be responsible for spawning the sun. This makes the camera module non-reusable in scenes where different lighting is required.
- **Input Coupling:** `src/game/camera.rs` manages `UiInputCaptureRes`. This is a general input management concern, not specific to the camera. It prevents other systems from knowing if UI is captured without depending on the camera module.

## 4. Dependencies

### Confused Math Libraries
`Cargo.toml` includes both `glam` and `nalgebra`.
- **Observation:** `src` solely uses `glam` (standard for Bevy).
- **Issue:** `nalgebra` is a heavy dependency. Including it without use bloats compile times and binary size.
- **Fix:** Remove `nalgebra`.

## 5. Naming & Conventions

- **Hungarian Notation:** You use `Res` suffixes for Resources (e.g., `TerrainWorldRes`). This is unnecessary noise. Bevy code typically relies on the type system (`Res<TerrainWorld>`) for clarity.
- **Hardcoded Strings:** `setup_construction_toolbar` uses the string literal `"construct"` as an ID. This is fragile. Use an `enum` or constants to prevent typos.
- **Inconsistent Directory Structure:** `game/world` vs `game/modes`. "World" is data, "Modes" is logic/state. This is a reasonable separation, but `objects` and `terrain` (data) living in `world` while their interactions live elsewhere can lead to "Feature Envy" where systems in `modes` reach deep into `world` internals.

## Recommendations
1.  **Refactor to idiomatic Bevy:** Kill `ObjectWorld`. Use standard Entities and Components.
2.  **Plugin-ify:** Split `main.rs` setup into `GamePlugin`, `TerrainPlugin`, `ObjectPlugin`, `CameraPlugin`.
3.  **Fix I/O:** Rewrite the GLTF bounds calculation to be async or build-time, using Bevy's asset system.
4.  **Cleanup:** Remove unused dependencies.
